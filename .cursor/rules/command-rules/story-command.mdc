---
description: 当用户输入/story命令时,显示当前开发阶段和项目进度
globs:
alwaysApply: false
---

# VibeCopilot 故事管理命令处理器

## 关键规则

- 当用户输入 `/story` 命令时，显示当前开发阶段和项目进度
- 支持显示当前活跃故事和相关任务
- 支持浏览所有故事并按里程碑、状态过滤
- 支持故事详情查看和状态更新
- 在执行计划变更前检查任务依赖

## 命令格式规范

基本语法: `/story [--id=故事ID] [--milestone=里程碑ID] [--status=状态] [--list]`

参数说明:
- `--id`: 可选，指定故事ID，设为当前活跃故事
- `--milestone`: 可选，按里程碑筛选故事
- `--status`: 可选，按状态筛选故事(planning/in_progress/completed/blocked)
- `--list`: 可选，列出所有符合筛选条件的故事

## 命令执行流程

```mermaid
flowchart TD
    A[开始] --> B{提供了故事ID?}
    B -->|是| C[查找故事]
    B -->|否| D{使用了--list?}
    D -->|是| E[应用过滤条件]
    D -->|否| F[显示当前活跃故事]
    C --> G[设为当前活跃故事]
    E --> H[列出符合条件的故事]
    F --> I[结束]
    G --> I
    H --> I
```

## 显示内容规范

### 当前故事显示 (`/story`)

显示当前活跃故事的详细信息、所属里程碑、任务列表和进度。

```
📘 当前活跃故事

故事ID: S2
标题: 应用核心引擎开发
状态: 进行中
所属里程碑: M2 "核心功能开发阶段"
完成度: 50% (2/4 任务)

描述:
实现VibeCopilot的核心引擎组件，包括状态管理、文档系统和基础AI集成能力。

包含任务:
✅ T2.1 核心引擎实现 (已完成)
▶️ T2.2 状态管理模块 (进行中, 50%)
⏹️ T2.3 文档管理系统 (待开始)
⏹️ T2.4 AI集成基础功能 (待开始)

预计完成时间: 2024-02-15 (还剩26天)
```

### 故事列表显示 (`/story --list`)

按里程碑和状态分组显示故事列表。

```
📚 故事列表

【里程碑 M1: 项目初始化 (已完成)】
✅ S1.1 项目架构设计 (已完成)
✅ S1.2 基础环境搭建 (已完成)

【里程碑 M2: 核心功能开发 (进行中, 40%)】
▶️ S2 应用核心引擎开发 (进行中, 50%)
⏹️ S2.1 用户界面基础组件 (待开始)

【里程碑 M3: 高级功能实现 (计划中)】
⏹️ S3.1 高级智能助手功能 (计划中)
⚠️ S3.2 插件系统 (已阻塞) - 依赖S2完成

共计: 6个故事 (2完成, 1进行中, 2待开始, 1阻塞)
```

### 故事详情显示 (`/story --id=S2`)

显示特定故事的详细信息，包括任务依赖关系图。

```
📖 故事详情: S2 "应用核心引擎开发"

基本信息:
- ID: S2
- 标题: 应用核心引擎开发
- 状态: 进行中 (开始于: 2024-01-10)
- 所属里程碑: M2 "核心功能开发阶段"
- 完成度: 50% (2/4 任务)

描述:
实现VibeCopilot的核心引擎组件，包括状态管理、文档系统和基础AI集成能力。
这是系统的核心部分，将直接影响后续功能开发。

任务依赖关系:
```

```mermaid
graph TD
    T2.1[T2.1 核心引擎实现\n已完成] --> T2.2[T2.2 状态管理模块\n进行中]
    T2.1 --> T2.3[T2.3 文档管理系统\n待开始]
    T2.2 --> T2.4[T2.4 AI集成基础功能\n待开始]
    T2.3 --> T2.4
```

```
预计完成时间: 2024-02-15 (还剩26天)
```

## 状态转换图

```mermaid
stateDiagram-v2
    [*] --> planning
    planning --> in_progress
    in_progress --> completed
    in_progress --> blocked
    blocked --> in_progress
    completed --> [*]
```

## 与其他命令的集成

- `/task`: 管理故事内的具体任务
- `/update`: 记录状态变更和进度
- `/check`: 提供项目整体状态概览
- `/plan`: 创建新故事和规划

## 示例

<example>
  用户: `/story`

  系统响应:
  ```
  📘 当前活跃故事

  故事ID: S2
  标题: 应用核心引擎开发
  状态: 进行中
  所属里程碑: M2 "核心功能开发阶段"
  完成度: 50% (2/4 任务)

  描述:
  实现VibeCopilot的核心引擎组件，包括状态管理、文档系统和基础AI集成能力。

  包含任务:
  ✅ T2.1 核心引擎实现 (已完成)
  ▶️ T2.2 状态管理模块 (进行中, 50%)
  ⏹️ T2.3 文档管理系统 (待开始)
  ⏹️ T2.4 AI集成基础功能 (待开始)

  预计完成时间: 2024-02-15 (还剩26天)
  ```

  用户: `/story --list`

  系统响应:
  ```
  📚 故事列表

  【里程碑 M1: 项目初始化 (已完成)】
  ✅ S1.1 项目架构设计 (已完成)
  ✅ S1.2 基础环境搭建 (已完成)

  【里程碑 M2: 核心功能开发 (进行中, 40%)】
  ▶️ S2 应用核心引擎开发 (进行中, 50%)
  ⏹️ S2.1 用户界面基础组件 (待开始)

  【里程碑 M3: 高级功能实现 (计划中)】
  ⏹️ S3.1 高级智能助手功能 (计划中)
  ⚠️ S3.2 插件系统 (已阻塞) - 依赖S2完成

  共计: 6个故事 (2完成, 1进行中, 2待开始, 1阻塞)
  ```

  用户: `/story --id=S3.1`

  系统响应:
  ```
  📖 故事详情: S3.1 "高级智能助手功能"

  基本信息:
  - ID: S3.1
  - 标题: 高级智能助手功能
  - 状态: 计划中
  - 所属里程碑: M3 "高级功能实现"
  - 完成度: 0% (0/3 任务)

  描述:
  实现VibeCopilot的高级AI助手功能，包括代码生成、重构建议和代码解释。

  任务依赖关系:
  - 需要等待S2 "应用核心引擎开发"完成

  预计开始时间: 2024-02-20
  预计完成时间: 2024-03-15
  ```
</example>

<example type="invalid">
  用户: `/story --id=S3.2 --status=in_progress`

  系统响应:
  ```
  ❌ 无法更新故事状态

  故事S3.2 "插件系统"无法开始，因为它依赖的故事S2 "应用核心引擎开发"尚未完成。

  请先完成依赖故事或解决阻塞问题后再尝试更新状态。
  ```
</example>

## 实现细节

### 数据源
- `data/roadmap.yaml`: 主要数据源，包含故事和任务详细信息
- GitHub API: 同步故事状态为GitHub项目看板中的卡片
- `.ai/cache/current_story.json`: 存储当前活跃故事

### 状态计算
- 故事完成度基于所有子任务的完成百分比计算
- 里程碑进度基于所有包含故事的平均完成度计算
- 故事状态级联影响父级里程碑和子任务状态

### 依赖处理
- 系统自动检测并验证故事和任务之间的依赖关系
- 防止违反依赖约束的状态更新
- 提供依赖关系可视化图
