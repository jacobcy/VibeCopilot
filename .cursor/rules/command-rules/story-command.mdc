---
description: 当用户输入/story命令时,显示当前开发阶段和项目进度
globs:
alwaysApply: false
---

# VibeCopilot 故事管理命令处理器

## 关键规则

- 当用户输入 `/story` 命令时，显示当前开发阶段和项目进度
- 使用 `/story new <故事名称>` 创建新故事并启动PRD生成流程
- 使用 `/story confirm <故事ID>` 确认故事PRD并更新状态为Approved
- 支持显示当前活跃故事和相关任务
- 支持浏览所有故事并按里程碑、状态过滤
- 支持故事详情查看和状态更新
- 在执行计划变更前检查任务依赖

## 命令格式规范

基本语法: `/story [子命令] [参数]`

子命令:
- 无子命令: 显示当前活跃故事信息
- `new <故事名称>`: 创建新故事并启动PRD生成流程
- `confirm <故事ID>`: 将PRD状态更新为Approved
- `list`: 列出所有符合筛选条件的故事

参数说明:
- `--id`: 可选，指定故事ID，设为当前活跃故事
- `--milestone`: 可选，按里程碑筛选故事
- `--status`: 可选，按状态筛选故事(planning/in_progress/completed/blocked)
- `--list`: 可选，列出所有符合筛选条件的故事

## 命令执行流程

```mermaid
flowchart TD
    A[开始] --> B{子命令?}
    B -->|无| C{提供了故事ID?}
    B -->|new| N[创建新故事]
    B -->|confirm| O[确认PRD]
    B -->|list| P[列出故事]

    C -->|是| D[查找故事]
    C -->|否| E[显示当前活跃故事]

    N --> Q[生成PRD文档]
    Q --> R[进入PRD编辑模式]

    O --> S[检查PRD内容]
    S --> T{内容完整?}
    T -->|是| U[更新PRD状态为Approved]
    T -->|否| V[提示补充内容]

    D --> F[设为当前活跃故事]

    E --> G[结束]
    F --> G
    P --> G
    R --> G
    U --> G
    V --> G
```

## 子命令处理规范

### 新建故事处理 (`/story new <故事名称>`)

创建新的用户故事并启动PRD生成流程:

1. 生成唯一故事ID
2. 在 `.ai/stories/` 创建故事文件
3. 在 `.ai/prd/` 创建对应PRD文档
4. 设置PRD状态为Draft
5. 启动story-flow流程，引导用户完成PRD编写

```
📝 已创建新故事

故事ID: S4.1
标题: 用户认证功能
状态: Draft
所属里程碑: M4 "用户体验增强"

PRD文档已创建: .ai/prd/prd-user-auth.md (状态: Draft)

请继续编写PRD内容，包括:
- 需求背景
- 功能描述
- 验收标准
- 优先级与依赖

完成PRD编写后，请使用 `/story confirm S4.1` 确认PRD
```

### 确认PRD处理 (`/story confirm <故事ID>`)

确认故事PRD完整性并更新状态:

1. 检查PRD文档是否包含所有必要内容
2. 验证内容完整性和质量
3. 更新PRD状态为Approved
4. 准备进入后续开发流程

```
✅ PRD已确认

故事ID: S4.1
标题: 用户认证功能
PRD状态: Approved (已更新)

PRD文档包含所有必要元素:
✓ 需求背景
✓ 功能描述
✓ 验收标准
✓ 优先级与依赖

现在可以进入开发阶段，请使用 `/plan` 命令创建开发计划
```

## 显示内容规范

### 当前故事显示 (`/story`)

显示当前活跃故事的详细信息、所属里程碑、任务列表和进度。

```
📘 当前活跃故事

故事ID: S2
标题: 应用核心引擎开发
状态: 进行中
所属里程碑: M2 "核心功能开发阶段"
完成度: 50% (2/4 任务)

描述:
实现VibeCopilot的核心引擎组件，包括状态管理、文档系统和基础AI集成能力。

包含任务:
✅ T2.1 核心引擎实现 (已完成)
▶️ T2.2 状态管理模块 (进行中, 50%)
⏹️ T2.3 文档管理系统 (待开始)
⏹️ T2.4 AI集成基础功能 (待开始)

预计完成时间: 2024-02-15 (还剩26天)
```

### 故事列表显示 (`/story list` 或 `/story --list`)

按里程碑和状态分组显示故事列表。

```
📚 故事列表

【里程碑 M1: 项目初始化 (已完成)】
✅ S1.1 项目架构设计 (已完成)
✅ S1.2 基础环境搭建 (已完成)

【里程碑 M2: 核心功能开发 (进行中, 40%)】
▶️ S2 应用核心引擎开发 (进行中, 50%)
⏹️ S2.1 用户界面基础组件 (待开始)

【里程碑 M3: 高级功能实现 (计划中)】
⏹️ S3.1 高级智能助手功能 (计划中)
⚠️ S3.2 插件系统 (已阻塞) - 依赖S2完成

共计: 6个故事 (2完成, 1进行中, 2待开始, 1阻塞)
```

### 故事详情显示 (`/story --id=S2`)

显示特定故事的详细信息，包括任务依赖关系图。

```
📖 故事详情: S2 "应用核心引擎开发"

基本信息:
- ID: S2
- 标题: 应用核心引擎开发
- 状态: 进行中 (开始于: 2024-01-10)
- 所属里程碑: M2 "核心功能开发阶段"
- 完成度: 50% (2/4 任务)

描述:
实现VibeCopilot的核心引擎组件，包括状态管理、文档系统和基础AI集成能力。
这是系统的核心部分，将直接影响后续功能开发。

任务依赖关系:
```

```mermaid
graph TD
    T2.1[T2.1 核心引擎实现\n已完成] --> T2.2[T2.2 状态管理模块\n进行中]
    T2.1 --> T2.3[T2.3 文档管理系统\n待开始]
    T2.2 --> T2.4[T2.4 AI集成基础功能\n待开始]
    T2.3 --> T2.4
```

```
预计完成时间: 2024-02-15 (还剩26天)
```

## 状态转换图

```mermaid
stateDiagram-v2
    [*] --> planning
    planning --> in_progress
    in_progress --> completed
    in_progress --> blocked
    blocked --> in_progress
    completed --> [*]
```

## 与其他命令的集成

- `/flow story`: 启动story-flow流程
- `/task`: 管理故事内的具体任务
- `/update`: 记录状态变更和进度
- `/check`: 提供项目整体状态概览
- `/plan`: 创建新故事和规划

## 示例

<example>
  用户: `/story new 用户认证功能`

  系统响应:
  ```
  📝 已创建新故事

  故事ID: S4.1
  标题: 用户认证功能
  状态: Draft
  所属里程碑: M4 "用户体验增强"

  PRD文档已创建: .ai/prd/prd-user-auth.md (状态: Draft)

  请继续编写PRD内容，包括:
  - 需求背景
  - 功能描述
  - 验收标准
  - 优先级与依赖

  完成PRD编写后，请使用 `/story confirm S4.1` 确认PRD
  ```

  用户: `/story confirm S4.1`

  系统响应:
  ```
  ✅ PRD已确认

  故事ID: S4.1
  标题: 用户认证功能
  PRD状态: Approved (已更新)

  PRD文档包含所有必要元素:
  ✓ 需求背景
  ✓ 功能描述
  ✓ 验收标准
  ✓ 优先级与依赖

  现在可以进入开发阶段，请使用 `/plan` 命令创建开发计划
  ```

  用户: `/story`

  系统响应:
  ```
  📘 当前活跃故事

  故事ID: S2
  标题: 应用核心引擎开发
  状态: 进行中
  所属里程碑: M2 "核心功能开发阶段"
  完成度: 50% (2/4 任务)

  描述:
  实现VibeCopilot的核心引擎组件，包括状态管理、文档系统和基础AI集成能力。

  包含任务:
  ✅ T2.1 核心引擎实现 (已完成)
  ▶️ T2.2 状态管理模块 (进行中, 50%)
  ⏹️ T2.3 文档管理系统 (待开始)
  ⏹️ T2.4 AI集成基础功能 (待开始)

  预计完成时间: 2024-02-15 (还剩26天)
  ```
</example>

<example type="invalid">
  用户: `@story-flow.mdc 我们需要添加用户认证功能`

  系统响应:
  ```
  ❓ 是否需要创建新故事?

  我注意到您引用了story-flow规则。如果您想创建新的用户故事并启动PRD生成流程，请使用:

  /story new 用户认证功能

  这将创建新故事并引导您完成PRD文档编写。
  ```
</example>

## 实现细节

### 数据源
- `.ai/roadmap/current.yaml`: 主要数据源，包含故事和任务详细信息
- `.ai/prd/`: 存储PRD文档
- GitHub API: 同步故事状态为GitHub项目看板中的卡片
- `.ai/cache/current_story.json`: 存储当前活跃故事

### 状态计算
- 故事完成度基于所有子任务的完成百分比计算
- 里程碑进度基于所有包含故事的平均完成度计算
- 故事状态级联影响父级里程碑和子任务状态

### 依赖处理
- 系统自动检测并验证故事和任务之间的依赖关系
- 防止违反依赖约束的状态更新
- 提供依赖关系可视化图
