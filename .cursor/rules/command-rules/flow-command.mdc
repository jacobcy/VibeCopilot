---
description: 当用户输入/flow命令时，管理和执行VibeCopilot中定义的各种流程
globs:
alwaysApply: false
---

# VibeCopilot 流程执行命令处理器

## 关键规则

- 当用户输入 `/flow` 命令时，显示可用的流程列表
- 使用 `/flow <流程名称>` 启动特定流程
- 流程名称对应 flow-rules 目录下的 *-flow.mdc 规则文件
- 将流程规则(flow-rules)与命令执行(commands)明确分离
- 提供标准化的流程启动方式，保持一致的用户体验

## 命令格式规范

基本语法: `/flow [流程名称] [参数]`

流程参数:
- `story`: 启动需求确认和PRD生成流程（对应story-flow.mdc）
- `spec`: 启动开发计划制定流程（对应spec-flow.mdc）
- `coding`: 启动代码开发流程（对应coding-flow.mdc）
- `test`: 启动测试阶段流程（对应test-flow.mdc）
- `review`: 启动审核阶段流程（对应review-flow.mdc）
- `commit`: 启动代码提交流程（对应commit-flow.mdc）

参数说明:
- `--id`: 可选，指定相关对象ID（如故事ID、任务ID等）
- `--stage`: 可选，直接进入流程的特定阶段
- `--skip-check`: 可选，跳过前置条件检查（谨慎使用）

## 命令执行流程

```mermaid
flowchart TD
    A[开始] --> B{指定了流程名称?}
    B -->|是| C[查找对应流程规则]
    B -->|否| D[显示可用流程列表]
    C --> E{流程规则存在?}
    E -->|是| F[检查前置条件]
    E -->|否| G[提示流程不存在]
    F --> H{满足前置条件?}
    H -->|是| I[启动流程]
    H -->|否| J[提示条件不满足]
    D --> K[结束]
    G --> K
    I --> K
    J --> K
```

## 流程启动处理规范

### 显示可用流程 (`/flow`)

显示系统中所有可用的流程及其简要说明:

```
🔄 可用流程列表

1. story - 需求确认与PRD产出流程
   用途: 创建用户故事和PRD文档
   命令: /flow story [故事名称]

2. spec - 开发计划制定流程
   用途: 技术选型、架构设计和任务分解
   命令: /flow spec --id=<故事ID>

3. coding - 代码开发流程
   用途: 编写符合标准的高质量代码
   命令: /flow coding --id=<任务ID>

4. test - 测试阶段流程
   用途: 编写和执行测试，验证功能完整性
   命令: /flow test --id=<故事ID>

5. review - 审核阶段流程
   用途: 代码审核和文档完善
   命令: /flow review --id=<故事ID>

6. commit - 代码提交流程
   用途: 准备和执行代码提交
   命令: /flow commit --id=<任务ID>

使用 `/flow <流程名称>` 启动特定流程。
例如: `/flow story 用户认证功能`
```

### 启动特定流程 (`/flow <流程名称>`)

启动指定的流程并执行其定义的步骤:

```
🚀 启动 [流程名称] 流程

流程ID: F001
名称: 需求确认与PRD产出
对应规则: story-flow.mdc

前置条件检查:
✓ 流程规则文件存在
✓ 所需资源和权限已验证

流程已启动，请按照指引完成以下步骤:
1. 确认需求范围和优先级
2. 编写PRD文档
3. 审核和确认PRD

当前阶段: 1/3 (确认需求范围和优先级)
```

## 流程管理功能

### 流程状态查看

显示当前正在执行的流程状态:

```
📊 当前流程状态

流程ID: F001
名称: 需求确认与PRD产出
开始时间: 2024-05-05 14:30
当前阶段: 2/3 (编写PRD文档)
完成度: 33%

下一步操作:
- 完成PRD所有必要元素
- 使用 `/story confirm <故事ID>` 确认PRD
```

### 流程中断与恢复

支持中断和恢复流程执行:

```
⏸️ 流程已暂停

流程ID: F001
名称: 需求确认与PRD产出
当前状态: 已暂停
暂停时间: 2024-05-05 15:30
当前阶段: 2/3 (编写PRD文档)

使用 `/flow resume F001` 恢复流程执行
当前进度已保存
```

## 与其他命令的集成

- `/story`: 用于执行故事相关操作
- `/task`: 管理流程中的具体任务
- `/check`: 检查流程前置条件
- `/plan`: 在spec流程中使用
- `/update`: 更新流程执行状态

## 示例

<example>
  用户: `/flow`

  系统响应:
  ```
  🔄 可用流程列表

  1. story - 需求确认与PRD产出流程
     用途: 创建用户故事和PRD文档
     命令: /flow story [故事名称]

  2. spec - 开发计划制定流程
     用途: 技术选型、架构设计和任务分解
     命令: /flow spec --id=<故事ID>

  3. coding - 代码开发流程
     用途: 编写符合标准的高质量代码
     命令: /flow coding --id=<任务ID>

  4. test - 测试阶段流程
     用途: 编写和执行测试，验证功能完整性
     命令: /flow test --id=<故事ID>

  5. review - 审核阶段流程
     用途: 代码审核和文档完善
     命令: /flow review --id=<故事ID>

  6. commit - 代码提交流程
     用途: 准备和执行代码提交
     命令: /flow commit --id=<任务ID>

  使用 `/flow <流程名称>` 启动特定流程。
  例如: `/flow story 用户认证功能`
  ```

  用户: `/flow story 用户认证功能`

  系统响应:
  ```
  🚀 启动 故事流程

  流程ID: F001
  名称: 需求确认与PRD产出
  对应规则: story-flow.mdc

  已创建新故事:
  - ID: S4.1
  - 标题: 用户认证功能
  - 状态: Draft

  PRD文档已初始化: .ai/prd/prd-user-auth.md

  请按照以下步骤完成PRD制作:
  1. 确认需求范围和优先级
  2. 编写PRD文档内容
  3. 审核和确认PRD

  当前阶段: 1/3 (确认需求范围和优先级)
  请描述该功能的基本需求和预期效果。
  ```

  用户: `用户需要能够使用邮箱和密码登录系统，支持记住登录状态和找回密码功能。`

  系统响应:
  ```
  ✅ 需求已记录

  已更新PRD文档的需求背景部分。

  进入阶段: 2/3 (编写PRD文档内容)

  请继续补充以下内容:
  - 功能描述：详细说明登录流程和各功能点
  - 功能范围：明确包含和不包含的内容
  - 验收标准：如何判断功能实现成功
  - 优先级与依赖：重要性和依赖关系

  完成后，使用 `/story confirm S4.1` 确认PRD
  ```
</example>

<example type="invalid">
  用户: `/flow unknown`

  系统响应:
  ```
  ❌ 未知流程

  找不到名为 "unknown" 的流程。

  可用的流程有:
  - story (需求确认与PRD产出)
  - spec (开发计划制定)
  - coding (代码开发)
  - test (测试阶段)
  - review (审核阶段)
  - commit (代码提交)

  使用 `/flow` 查看完整的流程列表和说明。
  ```

  用户: `/flow spec`

  系统响应:
  ```
  ❌ 前置条件不满足

  无法启动 "开发计划制定" 流程，因为:
  - 未指定故事ID (使用 --id 参数)
  - 或当前没有活跃的故事

  请先使用以下命令设置活跃故事:
  - `/story --id=<故事ID>` 设置特定故事为活跃
  - 或 `/flow story <故事名称>` 创建新故事

  正确用法: `/flow spec --id=S4.1`
  ```
</example>

## 实现细节

### 流程规则映射
- 维护流程名称与规则文件的映射关系
- 自动加载flow-rules目录下的规则文件
- 提取每个规则的描述和执行条件

### 流程状态管理
- 在 `.ai/flows/` 目录下存储流程执行状态
- 记录当前阶段、完成度和暂停/恢复信息
- 支持流程的中断和恢复

### 前置条件检查
- 自动验证流程所需的前置条件
- 检查必要的文件和资源是否存在
- 验证用户权限和系统状态

### 流程执行追踪
- 记录流程执行的历史和变更
- 提供流程执行的统计和报告
- 分析流程执行效率和问题点
