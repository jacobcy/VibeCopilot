# 规则命令开发指南

## 概述

规则命令(`vibecopilot rule`)是VibeCopilot项目中用于管理规则模板的命令行工具。本指南针对希望扩展或维护规则命令功能的开发者，提供必要的技术细节和后续开发建议。

## 技术架构

规则命令的实现基于以下几个核心组件：

1. `RuleCommand` 类 - 命令处理器，负责解析和执行规则相关的命令
2. `TemplateManager` - 负责模板的加载、查询和管理
3. `TemplateEngine` - 负责模板的渲染
4. `RuleGenerator` - 负责基于模板生成规则

### 文件结构

```
src/
├── cli/
│   ├── commands/
│   │   ├── rule_command.py  # 规则命令实现
│   │   └── ...
│   ├── main.py              # 命令行入口
│   └── ...
├── templates/
│   ├── core/
│   │   ├── template_engine.py    # 模板引擎
│   │   ├── template_manager.py   # 模板管理器
│   │   └── rule_generator.py     # 规则生成器
│   ├── models/
│   │   └── template.py      # 模板数据模型
│   └── ...
└── ...
```

## 当前功能状态

| 功能 | 状态 | 描述 |
|------|------|------|
| `list` | ✅ 已实现 | 列出可用规则 |
| `show` | ✅ 已实现 | 显示规则详情 |
| `create` | ✅ 基本实现 | 创建新规则，但交互式功能尚未完成 |
| `delete` | ✅ 已实现 | 删除规则 |
| `validate` | ⚠️ 部分实现 | 验证规则，但验证逻辑不完整 |
| `edit` | ❌ 未实现 | 编辑现有规则 |
| `export` | ❌ 未实现 | 导出规则到文件 |
| `import` | ❌ 未实现 | 从文件导入规则 |

## 后续开发计划

以下是优先级排序的建议开发任务：

1. **完善交互式变量收集功能**
   - 实现 `_interactive_variables` 方法来支持命令行中的交互式变量输入
   - 为不同类型的变量提供适当的提示和验证

2. **实现规则编辑功能**
   - 开发 `_edit_rule` 方法，支持在命令行中编辑现有规则
   - 可考虑使用外部编辑器或提供简单的内联编辑功能

3. **增强规则验证功能**
   - 完善 `_validate_single_rule` 方法，添加更全面的规则验证逻辑
   - 支持验证规则内容、格式、引用完整性等

4. **实现规则导入/导出功能**
   - 完成 `_export_rule` 和 `_import_rule` 方法
   - 确保格式一致性和跨平台兼容性

5. **优化模板匹配算法**
   - 改进 `_get_template` 方法，实现更智能的模板匹配
   - 考虑添加模糊匹配和别名支持

## 开发指南

### 添加新命令

如需添加新的子命令，请按照以下步骤操作：

1. 在 `setup_arguments` 方法中定义新的子命令解析器和参数
2. 在 `execute` 方法中添加新命令的处理分支
3. 实现命令的具体处理方法（命名格式：`_<命令名>_rule`）
4. 更新帮助文本 `_show_help` 方法
5. 添加单元测试确保功能正确性

### 调试建议

开发过程中可使用以下命令进行调试：

```bash
# 设置更详细的日志输出
export VIBECOPILOT_LOG_LEVEL=DEBUG

# 使用Python调试器运行
python -m pdb src/cli/main.py rule <子命令> <参数>
```

## 代码贡献指南

1. 请遵循项目的代码规范和命名约定
2. 添加充分的注释和类型提示
3. 为新功能编写单元测试
4. 提交前运行测试确保代码质量
5. 填写详细的提交信息，说明变更内容和原因

## 常见问题

1. **模板找不到？**
   - 检查模板目录配置
   - 确认模板文件命名和格式正确

2. **参数解析问题？**
   - 命令行参数有两种传递方式：命名空间对象和字典
   - 确保通过 `isinstance(args, dict)` 检查并相应处理

3. **渲染错误？**
   - 检查变量名是否与模板中的占位符匹配
   - 确保变量值类型正确
