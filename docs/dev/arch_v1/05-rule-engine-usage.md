# 规则引擎使用指南

> **文档元数据**  
> 版本: 1.0  
> 更新日期: 2025-04-05  
> 状态: 已审核  
> 负责团队: 系统架构团队

## 1. 规则系统概述

VibeCopilot规则系统采用模块化设计，所有规则均存储在`.cursor/rules/`目录下，按功能分类组织。本指南适用于已了解规则基本概念，需要进一步深入了解规则系统的开发者。

### 1.1 规则目录结构

```
.cursor/rules/
├── core-rules/       # 核心规则和规则生成器
├── global-rules/     # 全局应用规则
├── tool-rules/       # 工具使用规则
├── ts-rules/         # TypeScript规则
├── ui-rules/         # UI开发规则
└── workflows/        # 工作流规则
```

规则通过`.mdc`文件定义，使用Markdown格式并包含YAML前置元数据。

## 2. 规则类型详解

### 2.1 代理选择型规则

由AI根据上下文自动选择应用的规则，适用于特定开发任务。

**元数据示例**:
```yaml
---
description: "代码审查规则"
agentSelected: true
---
```

**适用场景**:
- 代码审查
- 架构设计
- 性能优化
- 安全审计

### 2.2 全局规则

自动应用于所有对话的规则，适用于项目通用规范。

**元数据示例**:
```yaml
---
description: "项目编码规范"
alwaysApply: true
---
```

**适用场景**:
- 项目编码标准
- 团队协作准则
- 文档格式规范
- 命名约定

### 2.3 自动选择型规则

基于文件类型自动应用的规则，适用于语言特定编码规范。

**元数据示例**:
```yaml
---
description: "TypeScript规范"
globs: ["*.ts", "*.tsx"]
---
```

**适用场景**:
- 语言特定编码规范
- 框架使用指南
- 文件组织规则
- 测试编写规范

### 2.4 手动规则

需要显式调用的规则，适用于特定工作流程。

**元数据示例**:
```yaml
---
description: "部署流程指南"
manual: true
---
```

**适用场景**:
- 特定工作流程
- 专用工具指南
- 复杂任务步骤
- 临时规则

## 3. 规则文件格式

### 3.1 基本结构

规则文件使用Markdown格式，包含YAML前置元数据和Markdown内容：

```markdown
---
description: "规则描述"
globs: ["*.ts", "*.tsx"]
alwaysApply: false
agentSelected: true
version: "1.0.0"
author: "VibeCopilot Team"
tags: ["typescript", "best-practices"]
---

# 规则标题

## 规则分类1

- 规则条目1
- 规则条目2

## 规则分类2

- 规则条目3
- 规则条目4

## 示例

```typescript
// 推荐示例
const example = () => {
  // ...
};
```
```

### 3.2 元数据字段

| 字段 | 类型 | 描述 | 必填 |
|------|------|------|------|
| `description` | 字符串 | 规则描述 | 是 |
| `globs` | 字符串数组 | 适用的文件模式 | 否 |
| `alwaysApply` | 布尔值 | 是否全局应用 | 否 |
| `agentSelected` | 布尔值 | 是否代理选择 | 否 |
| `manual` | 布尔值 | 是否手动调用 | 否 |
| `version` | 字符串 | 规则版本 | 否 |
| `author` | 字符串 | 规则作者 | 否 |
| `tags` | 字符串数组 | 规则标签 | 否 |

### 3.3 内容结构

规则内容应包含以下部分：

1. **标题**: 使用一级标题(`#`)
2. **分类**: 使用二级标题(`##`)
3. **规则条目**: 使用无序列表(`-`)
4. **示例**: 使用代码块(` ``` `)
5. **说明**: 使用普通段落

## 4. 规则创建与管理

### 4.1 创建新规则

1. **使用模板**:
   ```bash
   cp .cursor/templates/rule-template.mdc .cursor/rules/my-category/my-rule.mdc
   ```

2. **编辑元数据**:
   修改YAML前置元数据，设置适当的规则类型和属性。

3. **编写规则内容**:
   按照规则内容结构编写规则。

4. **验证规则**:
   ```bash
   vibe-cli validate-rule .cursor/rules/my-category/my-rule.mdc
   ```

### 4.2 管理规则

1. **查看规则列表**:
   ```bash
   vibe-cli list-rules
   ```

2. **更新规则**:
   编辑规则文件，更新内容和元数据。

3. **删除规则**:
   ```bash
   rm .cursor/rules/my-category/my-rule.mdc
   ```

4. **导出规则**:
   ```bash
   vibe-cli export-rules --format json --output rules.json
   ```

## 5. 规则使用方法

### 5.1 自动应用规则

代理选择型、全局规则和自动选择型规则会自动应用，无需手动调用。

### 5.2 手动调用规则

在对话中使用`@规则名`格式调用手动规则：

```
@部署流程 如何部署到生产环境？
```

### 5.3 规则组合

多个规则可以组合使用，系统会自动处理规则间的依赖和优先级：

```
@代码审查 @性能优化 请检查这段代码的性能问题
```

## 6. 规则模板系统

### 6.1 内置模板

系统提供以下内置模板：

1. **基础规则模板**: 通用规则模板
2. **编码规范模板**: 适用于编码标准
3. **工作流模板**: 适用于工作流程
4. **工具指南模板**: 适用于工具使用指南

### 6.2 自定义模板

创建自定义模板：

1. 创建模板文件:
   ```bash
   touch .cursor/templates/my-template.mdc
   ```

2. 定义模板变量:
   ```markdown
   ---
   description: "{{description}}"
   globs: {{globs}}
   alwaysApply: {{alwaysApply}}
   ---

   # {{title}}

   ## 规则内容

   {{content}}
   ```

3. 使用模板:
   ```bash
   vibe-cli create-rule --template my-template --vars "title=我的规则,description=规则描述"
   ```

## 7. 最佳实践

### 7.1 规则设计原则

1. **简洁明了**: 规则应简洁明了，避免冗长
2. **具体实用**: 提供具体、可操作的指导
3. **示例丰富**: 包含实际代码示例
4. **分类清晰**: 使用明确的分类结构
5. **边界明确**: 明确规则的适用范围

### 7.2 规则编写技巧

1. **使用命令式语言**: "使用X而非Y"，"避免Z"
2. **提供理由**: 解释规则背后的原因
3. **包含反例**: 展示不推荐的做法
4. **使用视觉标记**: 使用图标或颜色区分重要性
5. **保持更新**: 定期更新规则以反映最新实践

## 8. 常见问题解答

### 8.1 规则文件问题

| 问题 | 解决方法 |
|------|---------|
| 规则不生效 | 检查文件格式和元数据设置 |
| 规则冲突 | 调整规则优先级或合并冲突规则 |
| 多个同名规则 | 检查不同目录下是否有同名规则文件 |

### 8.2 规则应用问题

| 问题 | 解决方法 |
|------|---------|
| 规则未自动应用 | 检查文件类型是否匹配globs设置 |
| 手动规则无法调用 | 确认规则名称拼写正确 |
| 规则应用顺序错误 | 调整规则优先级设置 |

### 8.3 性能问题

| 问题 | 解决方法 |
|------|---------|
| 规则加载缓慢 | 减少规则数量或优化规则内容 |
| 内存占用高 | 拆分大型规则为多个小规则 |
| 响应延迟 | 优化规则匹配算法或缓存规则 |
